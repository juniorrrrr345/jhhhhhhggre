const translations = {
  // Configuration des langues
  languages: {
    fr: { name: 'FranÃ§ais', flag: 'ğŸ‡«ğŸ‡·', code: 'fr' },
    en: { name: 'English', flag: 'ğŸ‡¬ğŸ‡§', code: 'en' },
    it: { name: 'Italiano', flag: 'ğŸ‡®ğŸ‡¹', code: 'it' },
    es: { name: 'EspaÃ±ol', flag: 'ğŸ‡ªğŸ‡¸', code: 'es' },
    de: { name: 'Deutsch', flag: 'ğŸ‡©ğŸ‡ª', code: 'de' }
  },

  // Traductions par dÃ©faut
  defaultTranslations: {
    // === MENU PRINCIPAL ===
    'menu_topPlugs': {
      fr: 'ğŸ” Top Des Plugs',
      en: 'ğŸ” Top Plugs',
      it: 'ğŸ” Top Negozi',
      es: 'ğŸ” Top Tiendas',
      de: 'ğŸ” Top Shops'
    },
    'menu_contact': {
      fr: 'ğŸ“ Contact',
      en: 'ğŸ“ Contact',
      it: 'ğŸ“ Contatto',
      es: 'ğŸ“ Contacto',
      de: 'ğŸ“ Kontakt'
    },
    'menu_info': {
      fr: 'â„¹ï¸ Info',
      en: 'â„¹ï¸ Info',
      it: 'â„¹ï¸ Info',
      es: 'â„¹ï¸ Info',
      de: 'â„¹ï¸ Info'
    },
    'menu_becomeDealer': {
      fr: 'ğŸ’¼ Devenir Plug',
      en: 'ğŸ’¼ Become Dealer',
      it: 'ğŸ’¼ Diventa Rivenditore',
      es: 'ğŸ’¼ Ser Distribuidor',
      de: 'ğŸ’¼ HÃ¤ndler werden'
    },
    'menu_language': {
      fr: 'ğŸŒ Langue',
      en: 'ğŸŒ Language',
      it: 'ğŸŒ Lingua',
      es: 'ğŸŒ Idioma',
      de: 'ğŸŒ Sprache'
    },
    'menu_translation': {
      fr: 'ğŸŒ Traduction',
      en: 'ğŸŒ Translation',
      it: 'ğŸŒ Traduzione',
      es: 'ğŸŒ TraducciÃ³n',
      de: 'ğŸŒ Ãœbersetzung'
    },
    'menu_main': {
      fr: 'ğŸ  Menu principal',
      en: 'ğŸ  Main menu',
      it: 'ğŸ  Menu principale',
      es: 'ğŸ  MenÃº principal',
      de: 'ğŸ  HauptmenÃ¼'
    },
    'menu_delivery': {
      fr: 'ğŸšš Livraison',
      en: 'ğŸšš Delivery',
      it: 'ğŸšš Consegna',
      es: 'ğŸšš Entrega',
      de: 'ğŸšš Lieferung'
    },

    // === FILTRES TOP PLUGS ===
    'filters_delivery': {
      fr: 'ğŸ“¦ Livraison',
      en: 'ğŸ“¦ Delivery',
      it: 'ğŸ“¦ Consegna',
      es: 'ğŸ“¦ Entrega',
      de: 'ğŸ“¦ Lieferung'
    },
    'filters_meetup': {
      fr: 'ğŸ¤ Meetup',
      en: 'ğŸ¤ Meetup',
      it: 'ğŸ¤ Incontro',
      es: 'ğŸ¤ Encuentro',
      de: 'ğŸ¤ Treffen'
    },
    'filters_postal': {
      fr: 'ğŸ“¬ Envoi Postal',
      en: 'ğŸ“¬ Postal Shipping',
      it: 'ğŸ“¬ Spedizione Postale',
      es: 'ğŸ“¬ EnvÃ­o Postal',
      de: 'ğŸ“¬ Postversand'
    },
    'filters_department': {
      fr: 'ğŸ“ DÃ©partement ğŸ”',
      en: 'ğŸ“ State/Region ğŸ”',
      it: 'ğŸ“ Regione ğŸ”',
      es: 'ğŸ“ Provincia ğŸ”',
      de: 'ğŸ“ Bundesland ğŸ”'
    },
    'filters_reset': {
      fr: 'ğŸ” RÃ©initialiser les filtres',
      en: 'ğŸ” Reset Filters',
      it: 'ğŸ” Reimposta Filtri',
      es: 'ğŸ” Reiniciar Filtros',
      de: 'ğŸ” Filter zurÃ¼cksetzen'
    },
    'filters_back': {
      fr: 'ğŸ”™ Retour',
      en: 'ğŸ”™ Back',
      it: 'ğŸ”™ Indietro',
      es: 'ğŸ”™ Volver',
      de: 'ğŸ”™ ZurÃ¼ck'
    },

    // === MESSAGES ===
    'messages_welcome': {
      fr: 'FINDYOURPLUG\nMINI-APP TELEGRAM\nCHILL',
      en: 'FINDYOURPLUG\nTELEGRAM MINI-APP\nCHILL',
      it: 'FINDYOURPLUG\nMINI-APP TELEGRAM\nCHILL',
      es: 'FINDYOURPLUG\nMINI-APP TELEGRAM\nCHILL',
      de: 'FINDYOURPLUG\nTELEGRAM MINI-APP\nCHILL'
    },
    'messages_contactUs': {
      fr: 'Contactez-nous pour plus d\'informations.',
      en: 'Contact us for more information.',
      it: 'Contattaci per maggiori informazioni.',
      es: 'ContÃ¡ctanos para mÃ¡s informaciÃ³n.',
      de: 'Kontaktieren Sie uns fÃ¼r weitere Informationen.'
    },
    'messages_contactSocial': {
      fr: 'ğŸ“± Nous contacter :',
      en: 'ğŸ“± Contact us:',
      it: 'ğŸ“± Contattaci:',
      es: 'ğŸ“± ContÃ¡ctanos:',
      de: 'ğŸ“± Kontaktiere uns:'
    },
    'messages_noPlugs': {
      fr: 'âŒ Aucun plug disponible pour le moment.',
      en: 'âŒ No plugs available at the moment.',
      it: 'âŒ Nessun negozio disponibile al momento.',
      es: 'âŒ No hay tiendas disponibles en este momento.',
      de: 'âŒ Keine Shops verfÃ¼gbar im Moment.'
    },
    'messages_shopsAvailable': {
      fr: 'boutiques disponibles',
      en: 'shops available',
      it: 'negozi disponibili',
      es: 'tiendas disponibles',
      de: 'Shops verfÃ¼gbar'
    },
    'messages_sortedByVotes': {
      fr: 'TriÃ©s par nombre de votes',
      en: 'Sorted by number of votes',
      it: 'Ordinati per numero di voti',
      es: 'Ordenados por nÃºmero de votos',
      de: 'Sortiert nach Anzahl der Stimmen'
    },
    'messages_noShops': {
      fr: 'âŒ Aucun plug disponible pour le moment.',
      en: 'âŒ No plugs available at the moment.',
      it: 'âŒ Nessun negozio disponibile al momento.',
      es: 'âŒ No hay tiendas disponibles en este momento.',
      de: 'âŒ Momentan sind keine Shops verfÃ¼gbar.'
    },

    // === INSCRIPTION ===
    'registration.title': {
      fr: 'ğŸ› ï¸ FORMULAIRE D\'INSCRIPTION â€“ FindYourPlug',
      en: 'ğŸ› ï¸ REGISTRATION FORM â€“ FindYourPlug',
      it: 'ğŸ› ï¸ MODULO DI REGISTRAZIONE â€“ FindYourPlug',
      es: 'ğŸ› ï¸ FORMULARIO DE REGISTRO â€“ FindYourPlug',
      de: 'ğŸ› ï¸ ANMELDEFORMULAR â€“ FindYourPlug'
    },
    'registration.step1': {
      fr: 'ğŸŸ¦ Ã‰tape 1 : Nom de Plug',
      en: 'ğŸŸ¦ Step 1: Plug Name',
      it: 'ğŸŸ¦ Fase 1: Nome Negozio',
      es: 'ğŸŸ¦ Paso 1: Nombre de Tienda',
      de: 'ğŸŸ¦ Schritt 1: Shop-Name'
    },
    'registration.letsStart': {
      fr: 'ğŸ“ CommenÃ§ons ton inscription sur FindYourPlug !',
      en: 'ğŸ“ Let\'s start your registration on FindYourPlug!',
      it: 'ğŸ“ Iniziamo la tua registrazione su FindYourPlug!',
      es: 'ğŸ“ Â¡Comencemos tu registro en FindYourPlug!',
      de: 'ğŸ“ Beginnen wir deine Anmeldung bei FindYourPlug!'
    },
    'registration.plugNameQuestion': {
      fr: 'Quel est ton **nom de Plug** ?',
      en: 'What is your **Plug name**?',
      it: 'Qual Ã¨ il tuo **nome del negozio**?',
      es: 'Â¿CuÃ¡l es tu **nombre de tienda**?',
      de: 'Wie lautet dein **Shop-Name**?'
    },
    'registration.pendingTitle': {
      fr: 'ğŸ“ **Demande en cours**',
      en: 'ğŸ“ **Application in progress**',
      it: 'ğŸ“ **Richiesta in corso**',
      es: 'ğŸ“ **Solicitud en curso**',
      de: 'ğŸ“ **Antrag in Bearbeitung**'
    },
    'registration.pendingMessage': {
      fr: 'Tu as dÃ©jÃ  une demande d\'inscription en cours de traitement.',
      en: 'You already have a registration request being processed.',
      it: 'Hai giÃ  una richiesta di registrazione in elaborazione.',
      es: 'Ya tienes una solicitud de registro en proceso.',
      de: 'Du hast bereits eine Registrierungsanfrage in Bearbeitung.'
    },
    'registration.pendingStatus': {
      fr: 'Statut: â³ En attente',
      en: 'Status: â³ Pending',
      it: 'Stato: â³ In attesa',
      es: 'Estado: â³ Pendiente',
      de: 'Status: â³ Ausstehend'
    },
    'registration.pendingWait': {
      fr: 'Merci de patienter pendant que nos Ã©quipes examinent ta demande !',
      en: 'Please wait while our teams review your request!',
      it: 'Attendi mentre i nostri team esaminano la tua richiesta!',
      es: 'Â¡Por favor espera mientras nuestros equipos revisan tu solicitud!',
      de: 'Bitte warte, wÃ¤hrend unsere Teams deine Anfrage prÃ¼fen!'
    },
    'registration.cancel': {
      fr: 'âŒ Annuler',
      en: 'âŒ Cancel',
      it: 'âŒ Annulla',
      es: 'âŒ Cancelar',
      de: 'âŒ Abbrechen'
    },
    'registration.backToMenu': {
      fr: 'ğŸ”™ Retour au menu',
      en: 'ğŸ”™ Back to menu',
      it: 'ğŸ”™ Torna al menu',
      es: 'ğŸ”™ Volver al menÃº',
      de: 'ğŸ”™ ZurÃ¼ck zum MenÃ¼'
    },

    // === SERVICES ===
    'service_delivery': {
      fr: 'Livraison',
      en: 'Delivery',
      it: 'Consegna',
      es: 'Entrega',
      de: 'Lieferung'
    },
    'service_meetup': {
      fr: 'Meetup',
      en: 'Meetup',
      it: 'Incontro',
      es: 'Encuentro',
      de: 'Treffen'
    },
    'service_postal': {
      fr: 'Envoi postal',
      en: 'Postal shipping',
      it: 'Spedizione postale',
      es: 'EnvÃ­o postal',
      de: 'Postversand'
    },
    'services_available': {
      fr: 'Services disponibles',
      en: 'Available services',
      it: 'Servizi disponibili',
      es: 'Servicios disponibles',
      de: 'VerfÃ¼gbare Services'
    },
    'countries_served': {
      fr: 'Pays desservis',
      en: 'Countries served',
      it: 'Paesi serviti',
      es: 'PaÃ­ses servidos',
      de: 'Bediente LÃ¤nder'
    },

    // === BOUTIQUES ===
    'shop_details': {
      fr: 'DÃ©tails de la boutique',
      en: 'Shop details',
      it: 'Dettagli del negozio',
      es: 'Detalles de la tienda',
      de: 'Shop-Details'
    },
    'shop_description_label': {
      fr: 'ğŸ“',
      en: 'ğŸ“',
      it: 'ğŸ“',
      es: 'ğŸ“',
      de: 'ğŸ“'
    },
    'vote_for_shop': {
      fr: 'Voter Pour ce Plug',
      en: 'Vote for this Plug',
      it: 'Vota per questo negozio',
      es: 'Votar por esta tienda',
      de: 'FÃ¼r diesen Shop stimmen'
    },
    'already_voted': {
      fr: 'DÃ©jÃ  votÃ©',
      en: 'Already voted',
      it: 'GiÃ  votato',
      es: 'Ya votado',
      de: 'Bereits abgestimmt'
    },
    'vote_count_singular': {
      fr: 'vote',
      en: 'vote',
      it: 'voto',
      es: 'voto',
      de: 'Stimme'
    },
    'vote_count_plural': {
      fr: 'votes',
      en: 'votes',
      it: 'voti',
      es: 'votos',
      de: 'Stimmen'
    },

    // === NAVIGATION ===
    'back_to_filters': {
      fr: 'Retour aux filtres',
      en: 'Back to filters',
      it: 'Torna ai filtri',
      es: 'Volver a filtros',
      de: 'ZurÃ¼ck zu Filtern'
    },
    'back_to_menu': {
      fr: 'Retour au menu',
      en: 'Back to menu',
      it: 'Torna al menu',
      es: 'Volver al menÃº',
      de: 'ZurÃ¼ck zum MenÃ¼'
    },
    'page_info': {
      fr: 'Page',
      en: 'Page',
      it: 'Pagina',
      es: 'PÃ¡gina',
      de: 'Seite'
    },

    // === MESSAGES D'Ã‰TAT ===
    'loading': {
      fr: 'Chargement...',
      en: 'Loading...',
      it: 'Caricamento...',
      es: 'Cargando...',
      de: 'Laden...'
    },
    'error_loading': {
      fr: 'Erreur lors du chargement',
      en: 'Error loading',
      it: 'Errore durante il caricamento',
      es: 'Error al cargar',
      de: 'Fehler beim Laden'
    },
    'shop_not_found': {
      fr: 'Boutique non trouvÃ©e ou inactive',
      en: 'Shop not found or inactive',
      it: 'Negozio non trovato o inattivo',
      es: 'Tienda no encontrada o inactiva',
      de: 'Shop nicht gefunden oder inaktiv'
    },

    // === FILTRES ===
    'filter_by_service': {
      fr: 'Filtrer par service',
      en: 'Filter by service',
      it: 'Filtra per servizio',
      es: 'Filtrar por servicio',
      de: 'Nach Service filtern'
    },
    'filter_by_country': {
      fr: 'Filtrer par pays',
      en: 'Filter by country',
      it: 'Filtra per paese',
      es: 'Filtrar por paÃ­s',
      de: 'Nach Land filtern'
    },
    'all_shops': {
      fr: 'Toutes les boutiques',
      en: 'All shops',
      it: 'Tutti i negozi',
      es: 'Todas las tiendas',
      de: 'Alle Shops'
    },
    'messages_shopsAvailable': {
      fr: 'boutiques disponibles',
      en: 'shops available',
      it: 'negozi disponibili',
      es: 'tiendas disponibles',
      de: 'Shops verfÃ¼gbar'
    },
    'total_shops': {
      fr: 'Total',
      en: 'Total',
      it: 'Totale',
      es: 'Total',
      de: 'Gesamt'
    },
    'shops_word': {
      fr: 'boutiques',
      en: 'shops',
      it: 'negozi',
      es: 'tiendas',
      de: 'Shops'
    },

    // === MESSAGES TOP PLUGS ===
    'messages_sortedByVotes': {
      fr: 'TriÃ©s par nombre de votes',
      en: 'Sorted by number of votes',
      it: 'Ordinati per numero di voti',
      es: 'Ordenados por nÃºmero de votos',
      de: 'Sortiert nach Anzahl der Stimmen'
    },
    'messages_welcome': {
      fr: 'ğŸ‘‹ Bienvenue sur FindYourPlug !',
      en: 'ğŸ‘‹ Welcome to FindYourPlug!',
      it: 'ğŸ‘‹ Benvenuto su FindYourPlug!',
      es: 'ğŸ‘‹ Â¡Bienvenido a FindYourPlug!',
      de: 'ğŸ‘‹ Willkommen bei FindYourPlug!'
    },
    'messages_noShops': {
      fr: 'âŒ Aucune boutique disponible pour le moment.',
      en: 'âŒ No shops available at the moment.',
      it: 'âŒ Nessun negozio disponibile al momento.',
      es: 'âŒ No hay tiendas disponibles en este momento.',
      de: 'âŒ Momentan sind keine Shops verfÃ¼gbar.'
    },
    
    // === FILTRES AVANCÃ‰S ===
    'filter_delivery_message': {
      fr: 'ğŸ“¦ Afficher les boutiques disponibles pour livraison',
      en: 'ğŸ“¦ Show shops available for delivery',
      it: 'ğŸ“¦ Mostra negozi disponibili per consegna',
      es: 'ğŸ“¦ Mostrar tiendas disponibles para entrega',
      de: 'ğŸ“¦ Shops fÃ¼r Lieferung anzeigen'
    },
    'filter_meetup_message': {
      fr: 'ğŸ¤ Afficher les boutiques disponibles pour meetup',
      en: 'ğŸ¤ Show shops available for meetup',
      it: 'ğŸ¤ Mostra negozi disponibili per incontro',
      es: 'ğŸ¤ Mostrar tiendas disponibles para encuentro',
      de: 'ğŸ¤ Shops fÃ¼r Treffen anzeigen'
    },
    'filter_postal_message': {
      fr: 'ğŸ“¬ Boutiques qui font des envois postaux',
      en: 'ğŸ“¬ Shops that do postal shipping',
      it: 'ğŸ“¬ Negozi che fanno spedizioni postali',
      es: 'ğŸ“¬ Tiendas que hacen envÃ­os postales',
      de: 'ğŸ“¬ Shops mit Postversand'
    },
    'filter_department_available': {
      fr: 'DÃ©partements disponibles pour',
      en: 'Available departments for',
      it: 'Dipartimenti disponibili per',
      es: 'Departamentos disponibles para',
      de: 'VerfÃ¼gbare BundeslÃ¤nder fÃ¼r'
    },
    'filter_shops_in_department': {
      fr: 'Boutiques en',
      en: 'Shops in',
      it: 'Negozi in',
      es: 'Tiendas en',
      de: 'Shops in'
    },

    // === ERREURS ET STATUTS ===
    'error_filtering': {
      fr: 'âŒ Erreur lors du filtrage',
      en: 'âŒ Error filtering',
      it: 'âŒ Errore nel filtraggio',
      es: 'âŒ Error al filtrar',
      de: 'âŒ Fehler beim Filtern'
    },
    'error_departments': {
      fr: 'âŒ Erreur lors du chargement des dÃ©partements',
      en: 'âŒ Error loading departments',
      it: 'âŒ Errore nel caricamento dei dipartimenti',
      es: 'âŒ Error al cargar departamentos',
      de: 'âŒ Fehler beim Laden der BundeslÃ¤nder'
    },
    'error_reset': {
      fr: 'âŒ Erreur lors de la rÃ©initialisation',
      en: 'âŒ Error resetting',
      it: 'âŒ Errore nel reset',
      es: 'âŒ Error al reiniciar',
      de: 'âŒ Fehler beim ZurÃ¼cksetzen'
    },
    'no_departments': {
      fr: 'âŒ Aucun dÃ©partement disponible',
      en: 'âŒ No departments available',
      it: 'âŒ Nessun dipartimento disponibile',
      es: 'âŒ No hay departamentos disponibles',
      de: 'âŒ Keine BundeslÃ¤nder verfÃ¼gbar'
    },
    'filters_reset': {
      fr: 'ğŸ”„ Filtres rÃ©initialisÃ©s',
      en: 'ğŸ”„ Filters reset',
      it: 'ğŸ”„ Filtri ripristinati',
      es: 'ğŸ”„ Filtros reiniciados',
      de: 'ğŸ”„ Filter zurÃ¼ckgesetzt'
    },
    'filters_reset_button': {
      fr: 'ğŸ” RÃ©initialiser les filtres',
      en: 'ğŸ” Reset filters',
      it: 'ğŸ” Ripristina filtri',
      es: 'ğŸ” Reiniciar filtros',
      de: 'ğŸ” Filter zurÃ¼cksetzen'
    },

    // === TITRES SYSTÃˆME ===
    'list_plugs_title': {
      fr: 'ğŸ”Œ Liste des Plugs',
      en: 'ğŸ”Œ Plugs List',
      it: 'ğŸ”Œ Lista Negozi',
      es: 'ğŸ”Œ Lista de Tiendas',
      de: 'ğŸ”Œ Shop-Liste'
    },
    'sorted_by_votes_subtitle': {
      fr: '(TriÃ©s par nombre de votes)',
      en: '(Sorted by number of votes)',
      it: '(Ordinati per numero di voti)',
      es: '(Ordenados por nÃºmero de votos)',
      de: '(Sortiert nach Anzahl der Stimmen)'
    },

    // === BOUTIQUE WEB ===
    'shop.title': {
      fr: 'FINDYOURPLUG',
      en: 'FINDYOURPLUG',
      it: 'FINDYOURPLUG',
      es: 'FINDYOURPLUG',
      de: 'FINDYOURPLUG'
    },
    'shop.loading': {
      fr: 'Chargement...',
      en: 'Loading...',
      it: 'Caricamento...',
      es: 'Cargando...',
      de: 'Laden...'
    },
    'shop.search': {
      fr: 'Rechercher',
      en: 'Search',
      it: 'Cerca',
      es: 'Buscar',
      de: 'Suchen'
    },
    'shop.home': {
      fr: 'Accueil',
      en: 'Home',
      it: 'Casa',
      es: 'Inicio',
      de: 'Startseite'
    },
    'shop.vip': {
      fr: 'VIP',
      en: 'VIP',
      it: 'VIP',
      es: 'VIP',
      de: 'VIP'
    },
    'shop.likes': {
      fr: 'votes',
      en: 'votes',
      it: 'voti',
      es: 'votos',
      de: 'Stimmen'
    }
  }
};

// Fonction pour obtenir la traduction
const getTranslation = (key, language = 'fr', customTranslations = null) => {
  // VÃ©rifier d'abord les traductions personnalisÃ©es
  if (customTranslations && customTranslations.has && customTranslations.has(key)) {
    const customTrans = customTranslations.get(key);
    if (customTrans && customTrans.get && customTrans.get(language)) {
      return customTrans.get(language);
    }
  }
  
  // Fallback vers les traductions par dÃ©faut
  const defaultTrans = translations.defaultTranslations[key];
  if (defaultTrans && defaultTrans[language]) {
    return defaultTrans[language];
  }
  
  // Fallback vers franÃ§ais si langue pas trouvÃ©e
  if (defaultTrans && defaultTrans.fr) {
    return defaultTrans.fr;
  }
  
  // Fallback final : retourner la clÃ©
  return key;
};

// Fonction pour crÃ©er le clavier de sÃ©lection de langue
const createLanguageKeyboard = (currentLanguage = 'fr') => {
  try {
    const { Markup } = require('telegraf');
    const buttons = [];
    
    // VÃ©rifier que les traductions existent
    if (!translations || !translations.languages) {
      console.error('âŒ Traductions non disponibles pour le clavier de langue');
      // Retourner un clavier minimal en cas d'erreur
      return Markup.inlineKeyboard([
        [Markup.button.callback('ğŸ‡«ğŸ‡· FranÃ§ais', 'lang_fr')],
        [Markup.button.callback('ğŸ‡¬ğŸ‡§ English', 'lang_en')],
        [Markup.button.callback('ğŸ”™ Retour', 'back_main')]
      ]);
    }
    
    console.log(`ğŸŒ CrÃ©ation clavier langue, langue actuelle: ${currentLanguage}`);
    
    // PremiÃ¨re ligne : drapeaux des langues
    const flagRow = [];
    Object.entries(translations.languages).forEach(([code, lang]) => {
      if (lang && lang.flag && lang.name) {
        const isSelected = code === currentLanguage;
        // Format: âœ… ğŸ‡«ğŸ‡· FranÃ§ais ou ğŸ‡«ğŸ‡· FranÃ§ais
        const buttonText = isSelected ? `âœ… ${lang.flag} ${lang.name}` : `${lang.flag} ${lang.name}`;
        flagRow.push(Markup.button.callback(buttonText, `lang_${code}`));
        console.log(`ğŸ”¤ Langue ${code}: ${buttonText} (sÃ©lectionnÃ©e: ${isSelected})`);
      }
    });
    
    // VÃ©rifier qu'on a au moins un bouton
    if (flagRow.length === 0) {
      console.error('âŒ Aucune langue disponible pour le clavier');
      // Retourner un clavier minimal en cas d'erreur
      return Markup.inlineKeyboard([
        [Markup.button.callback('ğŸ‡«ğŸ‡· FranÃ§ais', 'lang_fr')],
        [Markup.button.callback('ğŸ‡¬ğŸ‡§ English', 'lang_en')],
        [Markup.button.callback('ğŸ”™ Retour', 'back_main')]
      ]);
    }
    
    // Grouper par 2 boutons par ligne pour plus de lisibilitÃ©
    for (let i = 0; i < flagRow.length; i += 2) {
      buttons.push(flagRow.slice(i, i + 2));
    }
    
    // Ligne des boutons de navigation
    const navRow = [];
    
    // Bouton retour
    const backText = getTranslation('filters_back', currentLanguage) || 'ğŸ”™ Retour';
    navRow.push(Markup.button.callback(backText, 'back_main'));
    
    // Bouton "Retour au menu" pour aller directement au menu principal avec la langue choisie
    const menuText = getTranslation('menu_main', currentLanguage) || 'ğŸ  Menu principal';
    navRow.push(Markup.button.callback(menuText, 'goto_main_menu'));
    
    buttons.push(navRow);
    
    console.log(`âœ… Clavier langue crÃ©Ã© avec ${flagRow.length} langues`);
    return Markup.inlineKeyboard(buttons);
    
  } catch (error) {
    console.error('âŒ Erreur crÃ©ation clavier langue:', error);
    // Retourner un clavier minimal en cas d'erreur
    return Markup.inlineKeyboard([
      [Markup.button.callback('ğŸ‡«ğŸ‡· FranÃ§ais', 'lang_fr')],
      [Markup.button.callback('ğŸ‡¬ğŸ‡§ English', 'lang_en')],
      [Markup.button.callback('ğŸ”™ Retour', 'back_main')]
    ]);
  }
};

// Fonction pour initialiser les traductions par dÃ©faut
const initializeDefaultTranslations = async (Config) => {
  try {
    console.log('ğŸŒ Initialisation des traductions...');
    
    const config = await Config.findById('main');
    if (!config) {
      console.log('âŒ Config non trouvÃ©e pour initialiser traductions');
      return;
    }

    // Initialiser la structure languages si elle n'existe pas
    if (!config.languages) {
      config.languages = {
        enabled: true, // Activer par dÃ©faut
        currentLanguage: 'fr',
        availableLanguages: Object.entries(translations.languages).map(([code, lang]) => ({
          code,
          name: lang.name,
          flag: lang.flag,
          enabled: true
        })),
        translations: new Map()
      };
    }
    
    // Ajouter toutes les traductions par dÃ©faut - SANS POINTS DANS LES CLÃ‰S
    Object.entries(translations.defaultTranslations).forEach(([key, langs]) => {
      // Convertir les clÃ©s avec points en clÃ©s avec underscores si nÃ©cessaire
      const cleanKey = key.replace(/\./g, '_');
      
      if (!config.languages.translations.has(cleanKey)) {
        const langMap = new Map();
        Object.entries(langs).forEach(([langCode, text]) => {
          langMap.set(langCode, text);
        });
        config.languages.translations.set(cleanKey, langMap);
      }
    });
    
    await config.save();
    console.log('âœ… Traductions par dÃ©faut initialisÃ©es');
    
  } catch (error) {
    console.error('âŒ Erreur initialisation traductions:', error);
    console.log('âœ… Traductions initialisÃ©es'); // Continuer mÃªme en cas d'erreur
  }
};

// Fonction pour traduire automatiquement les descriptions
const translateDescription = (description, language = 'fr') => {
  if (!description || language === 'fr') {
    return description; // Retourner tel quel si franÃ§ais ou vide
  }

  // Dictionnaire de traductions pour mots/phrases communes
  const translations = {
    en: {
      'livraison': 'delivery',
      'meetup': 'meetup', 
      'envoi postal': 'postal shipping',
      'rapide': 'fast',
      'qualitÃ©': 'quality',
      'service': 'service',
      'disponible': 'available',
      'partout': 'everywhere',
      'partout en': 'everywhere in',
      'en france': 'in france',
      'et belgique': 'and belgium',
      'vers la': 'to',
      'france': 'france',
      'belgique': 'belgium',
      'suisse': 'switzerland',
      'luxembourg': 'luxembourg',
      'boutique': 'shop',
      'produits': 'products',
      'commande': 'order',
      'professionnel': 'professional'
    },
    it: {
      'livraison': 'consegna',
      'meetup': 'incontro',
      'envoi postal': 'spedizione postale',
      'rapide': 'veloce',
      'qualitÃ©': 'qualitÃ ',
      'service': 'servizio',
      'disponible': 'disponibile',
      'partout': 'ovunque',
      'partout en': 'ovunque in',
      'en france': 'in francia',
      'et belgique': 'e belgio',
      'vers la': 'verso la',
      'france': 'francia',
      'belgique': 'belgio',
      'suisse': 'svizzera',
      'luxembourg': 'lussemburgo',
      'boutique': 'negozio',
      'prodotti': 'prodotti',
      'commande': 'ordine',
      'professionnel': 'professionale'
    },
    es: {
      'livraison': 'entrega',
      'meetup': 'encuentro',
      'envoi postal': 'envÃ­o postal',
      'rapide': 'rÃ¡pido',
      'qualitÃ©': 'calidad',
      'service': 'servicio',
      'disponible': 'disponible',
      'partout': 'en todas partes',
      'partout en': 'en todas partes de',
      'en france': 'en francia',
      'et belgique': 'y bÃ©lgica',
      'vers la': 'hacia',
      'france': 'francia',
      'belgique': 'bÃ©lgica',
      'suisse': 'suiza',
      'luxembourg': 'luxemburgo',
      'boutique': 'tienda',
      'produits': 'productos',
      'commande': 'pedido',
      'professionnel': 'profesional'
    },
    de: {
      'livraison': 'lieferung',
      'meetup': 'treffen',
      'envoi postal': 'postversand',
      'rapide': 'schnell',
      'qualitÃ©': 'qualitÃ¤t',
      'service': 'service',
      'disponible': 'verfÃ¼gbar',
      'partout': 'Ã¼berall',
      'partout en': 'Ã¼berall in',
      'en france': 'in frankreich',
      'et belgique': 'und belgien',
      'vers la': 'nach',
      'france': 'frankreich',
      'belgique': 'belgien',
      'suisse': 'schweiz',
      'luxembourg': 'luxemburg',
      'boutique': 'shop',
      'produits': 'produkte',
      'commande': 'bestellung',
      'professionnel': 'professionell'
    }
  };

  if (!translations[language]) {
    return description; // Langue non supportÃ©e
  }

  let translatedText = description.toLowerCase();
  const langDict = translations[language];

  // Remplacer chaque mot/phrase
  Object.entries(langDict).forEach(([french, translated]) => {
    const regex = new RegExp(`\\b${french}\\b`, 'gi');
    translatedText = translatedText.replace(regex, translated);
  });

  // Capitaliser la premiÃ¨re lettre
  return translatedText.charAt(0).toUpperCase() + translatedText.slice(1);
};

// Export
module.exports = {
  translations,
  getTranslation,
  createLanguageKeyboard,
  initializeDefaultTranslations,
  translateDescription
};