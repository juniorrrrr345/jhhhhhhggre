const translations = {
  // Configuration des langues
  languages: {
    fr: { name: 'FranÃ§ais', flag: 'ğŸ‡«ğŸ‡·', code: 'fr' },
    en: { name: 'English', flag: 'ğŸ‡¬ğŸ‡§', code: 'en' },
    it: { name: 'Italiano', flag: 'ğŸ‡®ğŸ‡¹', code: 'it' },
    es: { name: 'EspaÃ±ol', flag: 'ğŸ‡ªğŸ‡¸', code: 'es' },
    de: { name: 'Deutsch', flag: 'ğŸ‡©ğŸ‡ª', code: 'de' }
  },

  // Traductions par dÃ©faut
  defaultTranslations: {
    // === MENU PRINCIPAL ===
    'menu_topPlugs': {
      fr: 'ğŸ” Top Des Plugs',
      en: 'ğŸ” Top Plugs',
      it: 'ğŸ” Top Negozi',
      es: 'ğŸ” Top Tiendas',
      de: 'ğŸ” Top Shops'
    },
    'menu_contact': {
      fr: 'ğŸ“ Contact',
      en: 'ğŸ“ Contact',
      it: 'ğŸ“ Contatto',
      es: 'ğŸ“ Contacto',
      de: 'ğŸ“ Kontakt'
    },
    'menu_info': {
      fr: 'â„¹ï¸ Info',
      en: 'â„¹ï¸ Info',
      it: 'â„¹ï¸ Info',
      es: 'â„¹ï¸ Info',
      de: 'â„¹ï¸ Info'
    },
    'menu_becomeDealer': {
      fr: 'ğŸ’¼ Devenir Plug',
      en: 'ğŸ’¼ Become Dealer',
      it: 'ğŸ’¼ Diventa Rivenditore',
      es: 'ğŸ’¼ Ser Distribuidor',
      de: 'ğŸ’¼ HÃ¤ndler werden'
    },
    'menu_language': {
      fr: 'ğŸŒ Langue',
      en: 'ğŸŒ Language',
      it: 'ğŸŒ Lingua',
      es: 'ğŸŒ Idioma',
      de: 'ğŸŒ Sprache'
    },
    'menu_translation': {
      fr: 'ğŸŒ Traduction',
      en: 'ğŸŒ Translation',
      it: 'ğŸŒ Traduzione',
      es: 'ğŸŒ TraducciÃ³n',
      de: 'ğŸŒ Ãœbersetzung'
    },
    'menu_delivery': {
      fr: 'ğŸšš Livraison',
      en: 'ğŸšš Delivery',
      it: 'ğŸšš Consegna',
      es: 'ğŸšš Entrega',
      de: 'ğŸšš Lieferung'
    },

    // === FILTRES TOP PLUGS ===
    'filters_delivery': {
      fr: 'ğŸ“¦ Livraison',
      en: 'ğŸ“¦ Delivery',
      it: 'ğŸ“¦ Consegna',
      es: 'ğŸ“¦ Entrega',
      de: 'ğŸ“¦ Lieferung'
    },
    'filters_meetup': {
      fr: 'ğŸ¤ Meetup',
      en: 'ğŸ¤ Meetup',
      it: 'ğŸ¤ Incontro',
      es: 'ğŸ¤ Encuentro',
      de: 'ğŸ¤ Treffen'
    },
    'filters_postal': {
      fr: 'ğŸ“¬ Envoi Postal',
      en: 'ğŸ“¬ Postal Shipping',
      it: 'ğŸ“¬ Spedizione Postale',
      es: 'ğŸ“¬ EnvÃ­o Postal',
      de: 'ğŸ“¬ Postversand'
    },
    'filters_department': {
      fr: 'ğŸ“ DÃ©partement ğŸ”',
      en: 'ğŸ“ State/Region ğŸ”',
      it: 'ğŸ“ Regione ğŸ”',
      es: 'ğŸ“ Provincia ğŸ”',
      de: 'ğŸ“ Bundesland ğŸ”'
    },
    'filters_reset': {
      fr: 'ğŸ” RÃ©initialiser les filtres',
      en: 'ğŸ” Reset Filters',
      it: 'ğŸ” Reimposta Filtri',
      es: 'ğŸ” Reiniciar Filtros',
      de: 'ğŸ” Filter zurÃ¼cksetzen'
    },
    'filters_back': {
      fr: 'ğŸ”™ Retour',
      en: 'ğŸ”™ Back',
      it: 'ğŸ”™ Indietro',
      es: 'ğŸ”™ Volver',
      de: 'ğŸ”™ ZurÃ¼ck'
    },

    // === MESSAGES ===
    'messages_welcome': {
      fr: 'FINDYOURPLUG\nMINI-APP TELEGRAM\nCHILL',
      en: 'FINDYOURPLUG\nTELEGRAM MINI-APP\nCHILL',
      it: 'FINDYOURPLUG\nMINI-APP TELEGRAM\nCHILL',
      es: 'FINDYOURPLUG\nMINI-APP TELEGRAM\nCHILL',
      de: 'FINDYOURPLUG\nTELEGRAM MINI-APP\nCHILL'
    },
    'messages_contactUs': {
      fr: 'Contactez-nous pour plus d\'informations.',
      en: 'Contact us for more information.',
      it: 'Contattaci per maggiori informazioni.',
      es: 'ContÃ¡ctanos para mÃ¡s informaciÃ³n.',
      de: 'Kontaktieren Sie uns fÃ¼r weitere Informationen.'
    },
    'messages_contactSocial': {
      fr: 'ğŸ“± Nous contacter :',
      en: 'ğŸ“± Contact us:',
      it: 'ğŸ“± Contattaci:',
      es: 'ğŸ“± ContÃ¡ctanos:',
      de: 'ğŸ“± Kontaktiere uns:'
    },
    'messages_noPlugs': {
      fr: 'âŒ Aucun plug disponible pour le moment.',
      en: 'âŒ No plugs available at the moment.',
      it: 'âŒ Nessun negozio disponibile al momento.',
      es: 'âŒ No hay tiendas disponibles en este momento.',
      de: 'âŒ Keine Shops verfÃ¼gbar im Moment.'
    },
    'messages_shopsAvailable': {
      fr: 'boutiques disponibles',
      en: 'shops available',
      it: 'negozi disponibili',
      es: 'tiendas disponibles',
      de: 'Shops verfÃ¼gbar'
    },
    'messages_sortedByVotes': {
      fr: 'TriÃ©s par nombre de votes',
      en: 'Sorted by number of votes',
      it: 'Ordinati per numero di voti',
      es: 'Ordenados por nÃºmero de votos',
      de: 'Sortiert nach Anzahl der Stimmen'
    },
    'messages_noShops': {
      fr: 'âŒ Aucun plug disponible pour le moment.',
      en: 'âŒ No plugs available at the moment.',
      it: 'âŒ Nessun negozio disponibile al momento.',
      es: 'âŒ No hay tiendas disponibles en este momento.',
      de: 'âŒ Momentan sind keine Shops verfÃ¼gbar.'
    },

    // === INSCRIPTION ===
    'registration.title': {
      fr: 'ğŸ› ï¸ FORMULAIRE D\'INSCRIPTION â€“ FindYourPlug',
      en: 'ğŸ› ï¸ REGISTRATION FORM â€“ FindYourPlug',
      it: 'ğŸ› ï¸ MODULO DI REGISTRAZIONE â€“ FindYourPlug',
      es: 'ğŸ› ï¸ FORMULARIO DE REGISTRO â€“ FindYourPlug',
      de: 'ğŸ› ï¸ ANMELDEFORMULAR â€“ FindYourPlug'
    },
    'registration.step1': {
      fr: 'ğŸŸ¦ Ã‰tape 1 : Nom de Plug',
      en: 'ğŸŸ¦ Step 1: Plug Name',
      it: 'ğŸŸ¦ Fase 1: Nome Negozio',
      es: 'ğŸŸ¦ Paso 1: Nombre de Tienda',
      de: 'ğŸŸ¦ Schritt 1: Shop-Name'
    },
    'registration.letsStart': {
      fr: 'ğŸ“ CommenÃ§ons ton inscription sur FindYourPlug !',
      en: 'ğŸ“ Let\'s start your registration on FindYourPlug!',
      it: 'ğŸ“ Iniziamo la tua registrazione su FindYourPlug!',
      es: 'ğŸ“ Â¡Comencemos tu registro en FindYourPlug!',
      de: 'ğŸ“ Beginnen wir deine Anmeldung bei FindYourPlug!'
    },
    'registration.cancel': {
      fr: 'âŒ Annuler',
      en: 'âŒ Cancel',
      it: 'âŒ Annulla',
      es: 'âŒ Cancelar',
      de: 'âŒ Abbrechen'
    },

    // === BOUTIQUE WEB ===
    'shop.title': {
      fr: 'FINDYOURPLUG',
      en: 'FINDYOURPLUG',
      it: 'FINDYOURPLUG',
      es: 'FINDYOURPLUG',
      de: 'FINDYOURPLUG'
    },
    'shop.loading': {
      fr: 'Chargement...',
      en: 'Loading...',
      it: 'Caricamento...',
      es: 'Cargando...',
      de: 'Laden...'
    },
    'shop.search': {
      fr: 'Rechercher',
      en: 'Search',
      it: 'Cerca',
      es: 'Buscar',
      de: 'Suchen'
    },
    'shop.home': {
      fr: 'Accueil',
      en: 'Home',
      it: 'Casa',
      es: 'Inicio',
      de: 'Startseite'
    },
    'shop.vip': {
      fr: 'VIP',
      en: 'VIP',
      it: 'VIP',
      es: 'VIP',
      de: 'VIP'
    },
    'shop.likes': {
      fr: 'votes',
      en: 'votes',
      it: 'voti',
      es: 'votos',
      de: 'Stimmen'
    }
  }
};

// Fonction pour obtenir la traduction
const getTranslation = (key, language = 'fr', customTranslations = null) => {
  // VÃ©rifier d'abord les traductions personnalisÃ©es
  if (customTranslations && customTranslations.has && customTranslations.has(key)) {
    const customTrans = customTranslations.get(key);
    if (customTrans && customTrans.get && customTrans.get(language)) {
      return customTrans.get(language);
    }
  }
  
  // Fallback vers les traductions par dÃ©faut
  const defaultTrans = translations.defaultTranslations[key];
  if (defaultTrans && defaultTrans[language]) {
    return defaultTrans[language];
  }
  
  // Fallback vers franÃ§ais si langue pas trouvÃ©e
  if (defaultTrans && defaultTrans.fr) {
    return defaultTrans.fr;
  }
  
  // Fallback final : retourner la clÃ©
  return key;
};

// Fonction pour crÃ©er le clavier de sÃ©lection de langue
const createLanguageKeyboard = (currentLanguage = 'fr') => {
  try {
    const { Markup } = require('telegraf');
    const buttons = [];
    
    // VÃ©rifier que les traductions existent
    if (!translations || !translations.languages) {
      console.error('âŒ Traductions non disponibles pour le clavier de langue');
      // Retourner un clavier minimal en cas d'erreur
      return Markup.inlineKeyboard([
        [Markup.button.callback('ğŸ‡«ğŸ‡· FranÃ§ais', 'lang_fr')],
        [Markup.button.callback('ğŸ‡¬ğŸ‡§ English', 'lang_en')],
        [Markup.button.callback('ğŸ”™ Retour', 'back_main')]
      ]);
    }
    
    console.log(`ğŸŒ CrÃ©ation clavier langue, langue actuelle: ${currentLanguage}`);
    
    // PremiÃ¨re ligne : drapeaux des langues
    const flagRow = [];
    Object.entries(translations.languages).forEach(([code, lang]) => {
      if (lang && lang.flag && lang.name) {
        const isSelected = code === currentLanguage;
        // Format: âœ… ğŸ‡«ğŸ‡· FranÃ§ais ou ğŸ‡«ğŸ‡· FranÃ§ais
        const buttonText = isSelected ? `âœ… ${lang.flag} ${lang.name}` : `${lang.flag} ${lang.name}`;
        flagRow.push(Markup.button.callback(buttonText, `lang_${code}`));
        console.log(`ğŸ”¤ Langue ${code}: ${buttonText} (sÃ©lectionnÃ©e: ${isSelected})`);
      }
    });
    
    // VÃ©rifier qu'on a au moins un bouton
    if (flagRow.length === 0) {
      console.error('âŒ Aucune langue disponible pour le clavier');
      // Retourner un clavier minimal en cas d'erreur
      return Markup.inlineKeyboard([
        [Markup.button.callback('ğŸ‡«ğŸ‡· FranÃ§ais', 'lang_fr')],
        [Markup.button.callback('ğŸ‡¬ğŸ‡§ English', 'lang_en')],
        [Markup.button.callback('ğŸ”™ Retour', 'back_main')]
      ]);
    }
    
    // Grouper par 2 boutons par ligne pour plus de lisibilitÃ©
    for (let i = 0; i < flagRow.length; i += 2) {
      buttons.push(flagRow.slice(i, i + 2));
    }
    
    // Ligne de retour
    const backText = getTranslation('filters_back', currentLanguage) || 'ğŸ”™ Retour';
    buttons.push([Markup.button.callback(backText, 'back_main')]);
    
    console.log(`âœ… Clavier langue crÃ©Ã© avec ${flagRow.length} langues`);
    return Markup.inlineKeyboard(buttons);
    
  } catch (error) {
    console.error('âŒ Erreur crÃ©ation clavier langue:', error);
    // Retourner un clavier minimal en cas d'erreur
    return Markup.inlineKeyboard([
      [Markup.button.callback('ğŸ‡«ğŸ‡· FranÃ§ais', 'lang_fr')],
      [Markup.button.callback('ğŸ‡¬ğŸ‡§ English', 'lang_en')],
      [Markup.button.callback('ğŸ”™ Retour', 'back_main')]
    ]);
  }
};

// Fonction pour initialiser les traductions par dÃ©faut
const initializeDefaultTranslations = async (Config) => {
  try {
    console.log('ğŸŒ Initialisation des traductions...');
    
    const config = await Config.findById('main');
    if (!config) {
      console.log('âŒ Config non trouvÃ©e pour initialiser traductions');
      return;
    }

    // Initialiser la structure languages si elle n'existe pas
    if (!config.languages) {
      config.languages = {
        enabled: true, // Activer par dÃ©faut
        currentLanguage: 'fr',
        availableLanguages: Object.entries(translations.languages).map(([code, lang]) => ({
          code,
          name: lang.name,
          flag: lang.flag,
          enabled: true
        })),
        translations: new Map()
      };
    }
    
    // Ajouter toutes les traductions par dÃ©faut - SANS POINTS DANS LES CLÃ‰S
    Object.entries(translations.defaultTranslations).forEach(([key, langs]) => {
      // Convertir les clÃ©s avec points en clÃ©s avec underscores si nÃ©cessaire
      const cleanKey = key.replace(/\./g, '_');
      
      if (!config.languages.translations.has(cleanKey)) {
        const langMap = new Map();
        Object.entries(langs).forEach(([langCode, text]) => {
          langMap.set(langCode, text);
        });
        config.languages.translations.set(cleanKey, langMap);
      }
    });
    
    await config.save();
    console.log('âœ… Traductions par dÃ©faut initialisÃ©es');
    
  } catch (error) {
    console.error('âŒ Erreur initialisation traductions:', error);
    console.log('âœ… Traductions initialisÃ©es'); // Continuer mÃªme en cas d'erreur
  }
};

// Export
module.exports = {
  translations,
  getTranslation,
  createLanguageKeyboard,
  initializeDefaultTranslations
};