nohup: ignoring input
🔄 Tentative de connexion MongoDB #1...
✅ MongoDB connecté avec succès
✅ MongoDB connecté: ac-rxln3be-shard-00-00.oghzx2v.mongodb.net
📊 Loaded 6 existing users from database
ℹ️ Configuration existante trouvée
🌍 Initialisation des traductions...
🌍 Initialisation des traductions...
✅ Traductions par défaut initialisées
✅ Traductions initialisées
🔄 Migration automatique des réseaux sociaux...
🔗 Connexion à MongoDB réussie
📋 3 plugs trouvés
🎉 Migration terminée: 0 plugs migrés
✅ Migration terminée avec succès
🔄 Initialisation du cache...
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 3 plugs, config: OK
✅ Cache initialisé et programmé pour se rafraîchir toutes les 30s
✅ Bot en mode polling (développement)
✅ Serveur démarré sur le port 3007
📱 Bot Telegram connecté
🌐 API disponible sur http://localhost:3007
📊 Cache: 3 plugs, config: OK
🔄 Callback reçu: top_plugs
👤 User ID: 7670522278, Chat ID: 7670522278
📝 Message ID: 5724
📍 Context updated to: top_plugs
🔄 Callback reçu: top_plugs
👤 User ID: 7670522278, Chat ID: 7670522278
📝 Message ID: 5724
📍 Context updated to: top_plugs
Erreur answerCbQuery: 400: Bad Request: query is too old and response timeout expired or query ID is invalid
Erreur answerCbQuery: 400: Bad Request: query is too old and response timeout expired or query ID is invalid
Erreur dans handleTopPlugs: TelegramError: 400: Bad Request: query is too old and response timeout expired or query ID is invalid
    at Telegram.callApi (/workspace/bot/node_modules/telegraf/lib/core/network/client.js:315:19)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async handleTopPlugs (/workspace/bot/src/handlers/plugsHandler.js:17:5)
    at async execute (/workspace/bot/node_modules/telegraf/lib/composer.js:518:17)
    at async /workspace/bot/node_modules/telegraf/lib/composer.js:519:21
    at async execute (/workspace/bot/node_modules/telegraf/lib/composer.js:518:17)
    at async /workspace/bot/node_modules/telegraf/lib/composer.js:519:21
    at async execute (/workspace/bot/node_modules/telegraf/lib/composer.js:518:17)
    at async /workspace/bot/node_modules/telegraf/lib/composer.js:519:21
    at async execute (/workspace/bot/node_modules/telegraf/lib/composer.js:518:17) {
  response: {
    ok: false,
    error_code: 400,
    description: 'Bad Request: query is too old and response timeout expired or query ID is invalid'
  },
  on: {
    method: 'answerCallbackQuery',
    payload: { text: undefined, callback_query_id: '5274526216938697245' }
  }
}
Erreur dans handleTopPlugs: TelegramError: 400: Bad Request: query is too old and response timeout expired or query ID is invalid
    at Telegram.callApi (/workspace/bot/node_modules/telegraf/lib/core/network/client.js:315:19)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async handleTopPlugs (/workspace/bot/src/handlers/plugsHandler.js:17:5)
    at async execute (/workspace/bot/node_modules/telegraf/lib/composer.js:518:17)
    at async /workspace/bot/node_modules/telegraf/lib/composer.js:519:21
    at async execute (/workspace/bot/node_modules/telegraf/lib/composer.js:518:17)
    at async /workspace/bot/node_modules/telegraf/lib/composer.js:519:21
    at async execute (/workspace/bot/node_modules/telegraf/lib/composer.js:518:17)
    at async /workspace/bot/node_modules/telegraf/lib/composer.js:519:21
    at async execute (/workspace/bot/node_modules/telegraf/lib/composer.js:518:17) {
  response: {
    ok: false,
    error_code: 400,
    description: 'Bad Request: query is too old and response timeout expired or query ID is invalid'
  },
  on: {
    method: 'answerCallbackQuery',
    payload: { text: undefined, callback_query_id: '5274526216913333199' }
  }
}
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 3 plugs, config: OK
🚀 Commande /start reçue de: 7670522278
❌ Erreur lors de l'enregistrement utilisateur: StrictModeError: Path "userId" is not in schema, strict mode is `true`, and upsert is `true`.
    at cast (/workspace/bot/node_modules/mongoose/lib/cast.js:305:17)
    at Query.cast (/workspace/bot/node_modules/mongoose/lib/query.js:5055:12)
    at Query._castConditions (/workspace/bot/node_modules/mongoose/lib/query.js:2351:10)
    at model.Query._findOneAndUpdate (/workspace/bot/node_modules/mongoose/lib/query.js:3454:8)
    at model.Query.exec (/workspace/bot/node_modules/mongoose/lib/query.js:4604:80)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async handleStart (/workspace/bot/src/handlers/startHandler.js:65:7)
    at async execute (/workspace/bot/node_modules/telegraf/lib/composer.js:518:17)
    at async /workspace/bot/node_modules/telegraf/lib/composer.js:519:21
    at async execute (/workspace/bot/node_modules/telegraf/lib/composer.js:518:17) {
  isImmutableError: false,
  path: 'userId'
}
🔄 Config rechargée depuis la DB
🌍 Menu principal affiché en langue: es
📸 Envoi message avec image: https://i.imgur.com/leViC3R.jpeg
✅ Message avec image envoyé
🔄 Callback reçu: top_plugs
👤 User ID: 7670522278, Chat ID: 7670522278
📝 Message ID: 5726
📍 Context updated to: top_plugs
🔝 Top Plugs: 3 plugs trouvés
🖼️ Images: plug=false, welcome=true, isPlugDetails=false, using=true
🖼️ Modification avec image: https://i.imgur.com/leViC3R.jpeg
🔄 Callback reçu: top_plugs
👤 User ID: 7670522278, Chat ID: 7670522278
📝 Message ID: 5726
📍 Context updated to: top_plugs
🔝 Top Plugs: 3 plugs trouvés
🖼️ Images: plug=false, welcome=true, isPlugDetails=false, using=true
🖼️ Modification avec image: https://i.imgur.com/leViC3R.jpeg
⚠️ Impossible de modifier l'image, fallback vers édition caption
❌ Erreur modification message avec image: TelegramError: 400: Bad Request: message is not modified: specified new message content and reply markup are exactly the same as a current content and reply markup of the message
    at Telegram.callApi (/workspace/bot/node_modules/telegraf/lib/core/network/client.js:315:19)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async editMessageWithImage (/workspace/bot/src/utils/messageHelper.js:61:9)
    at async handleTopPlugs (/workspace/bot/src/handlers/plugsHandler.js:48:7)
    at async execute (/workspace/bot/node_modules/telegraf/lib/composer.js:518:17)
    at async /workspace/bot/node_modules/telegraf/lib/composer.js:519:21
    at async execute (/workspace/bot/node_modules/telegraf/lib/composer.js:518:17)
    at async /workspace/bot/node_modules/telegraf/lib/composer.js:519:21
    at async execute (/workspace/bot/node_modules/telegraf/lib/composer.js:518:17)
    at async /workspace/bot/node_modules/telegraf/lib/composer.js:519:21 {
  response: {
    ok: false,
    error_code: 400,
    description: 'Bad Request: message is not modified: specified new message content and reply markup are exactly the same as a current content and reply markup of the message'
  },
  on: {
    method: 'editMessageCaption',
    payload: {
      chat_id: 7670522278,
      message_id: 5726,
      inline_message_id: undefined,
      reply_markup: [Object],
      parse_mode: 'Markdown',
      caption: '🔝 **🔝 Top Tiendas**\n' +
        '\n' +
        '*(Ordenados por número de votos)*\n' +
        '\n' +
        '📊 Total : 3 tiendas'
    }
  }
}
🔄 Callback reçu: plug_687e233151eb51ad38c5b9e7_from_top_plugs
👤 User ID: 7670522278, Chat ID: 7670522278
📝 Message ID: 5727
📍 Context updated to: top_plugs
🔍 handlePlugDetails: plugId=687e233151eb51ad38c5b9e7, returnContext=top_plugs
📦 Plug found: Plugs pour tester (active: true)
🖼️ Images: plug=true, welcome=true, isPlugDetails=true, using=true
🖼️ Modification avec image: https://i.imgur.com/DD5OU6o.jpeg
🔄 Callback reçu: top_plugs
👤 User ID: 7670522278, Chat ID: 7670522278
📝 Message ID: 5727
📍 Context updated to: top_plugs
🔝 Top Plugs: 3 plugs trouvés
🖼️ Images: plug=false, welcome=true, isPlugDetails=false, using=true
🖼️ Modification avec image: https://i.imgur.com/leViC3R.jpeg
🔄 Callback reçu: top_plugs
👤 User ID: 7670522278, Chat ID: 7670522278
📝 Message ID: 5727
📍 Context updated to: top_plugs
🔝 Top Plugs: 3 plugs trouvés
🖼️ Images: plug=false, welcome=true, isPlugDetails=false, using=true
🖼️ Modification avec image: https://i.imgur.com/leViC3R.jpeg
⚠️ Impossible de modifier l'image, fallback vers édition caption
❌ Erreur modification message avec image: TelegramError: 400: Bad Request: message is not modified: specified new message content and reply markup are exactly the same as a current content and reply markup of the message
    at Telegram.callApi (/workspace/bot/node_modules/telegraf/lib/core/network/client.js:315:19)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async editMessageWithImage (/workspace/bot/src/utils/messageHelper.js:61:9)
    at async handleTopPlugs 🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 3 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 3 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 3 plugs, config: OK
ce/bot/node_modules/telegraf/lib/composer.js:518:17)
    at async /workspace/bot/node_modules/telegraf/lib/composer.js:519:21
    at async execute (/workspace/bot/node_modules/telegraf/lib/composer.js:518:17)
    at async /workspace/bot/node_modules/telegraf/lib/composer.js:519:21 {
  response: {
    ok: false,
    error_code: 400,
    description: 'Bad Request: message is not modified: specified new message content and reply markup are exactly the same as a current content and reply markup of the message'
  },
  on: {
    method: 'editMessageCaption',
    payload: {
      chat_id: 7670522278,
      message_id: 5727,
      inline_message_id: undefined,
      reply_markup: [Object],
      parse_mode: 'Markdown',
      caption: '🔝 **🔝 Top Tiendas**\n' +
        '\n' +
        '*(Ordenados por número de votos)*\n' +
        '\n' +
        '📊 Total : 3 tiendas'
    }
  }
}
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 3 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 3 plugs, config: OK
🚀 Commande /start reçue de: 7670522278
❌ Erreur lors de l'enregistrement utilisateur: StrictModeError: Path "userId" is not in schema, strict mode is `true`, and upsert is `true`.
    at cast (/workspace/bot/node_modules/mongoose/lib/cast.js:305:17)
    at Query.cast (/workspace/bot/node_modules/mongoose/lib/query.js:5055:12)
    at Query._castConditions (/workspace/bot/node_modules/mongoose/lib/query.js:2351:10)
    at model.Query._findOneAndUpdate (/workspace/bot/node_modules/mongoose/lib/query.js:3454:8)
    at model.Query.exec (/workspace/bot/node_modules/mongoose/lib/query.js:4604:80)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async handleStart (/workspace/bot/src/handlers/startHandler.js:65:7)
    at async execute (/workspace/bot/node_modules/telegraf/lib/composer.js:518:17)
    at async /workspace/bot/node_modules/telegraf/lib/composer.js:519:21
    at async execute (/workspace/bot/node_modules/telegraf/lib/composer.js:518:17) {
  isImmutableError: false,
  path: 'userId'
}
🔄 Config rechargée depuis la DB
🌍 Menu principal affiché en langue: es
📸 Envoi message avec image: https://i.imgur.com/leViC3R.jpeg
✅ Message avec image envoyé
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 3 plugs, config: OK
