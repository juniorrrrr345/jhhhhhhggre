nohup: ignoring input
🔄 Tentative de connexion MongoDB #1...
✅ MongoDB connecté avec succès
✅ MongoDB connecté: tesye-shard-00-00.qazpla.mongodb.net
📊 Loaded 0 existing users from database
ℹ️ Configuration existante trouvée
🌍 Initialisation des traductions...
🌍 Initialisation des traductions...
✅ Traductions par défaut initialisées
✅ Traductions initialisées
🔄 Migration automatique des réseaux sociaux...
🔗 Connexion à MongoDB réussie
📋 1 plugs trouvés
🎉 Migration terminée: 0 plugs migrés
✅ Migration terminée avec succès
🔄 Initialisation du cache...
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
✅ Cache initialisé et programmé pour se rafraîchir toutes les 30s
✅ Bot en mode polling (développement)
✅ Serveur démarré sur le port 3025
📱 Bot Telegram connecté
🌐 API disponible sur http://localhost:3025
📊 Cache: 1 plugs, config: OK
🔄 Callback reçu: top_plugs
👤 User ID: 7548021607, Chat ID: 7548021607
📝 Message ID: 5824
📍 Context updated to: top_plugs
🔝 Top Plugs affiché en langue: es
🖼️ Images: plug=false, welcome=true, isPlugDetails=false, using=true
🖼️ Modification avec image: https://i.imgur.com/soi9PbO.jpeg
🔄 Callback reçu: top_reset_filters
👤 User ID: 7548021607, Chat ID: 7548021607
📝 Message ID: 5824
⚠️ Erreur édition directe, tentative édition caption: 400: Bad Request: message is not modified: specified new message content and reply markup are exactly the same as a current content and reply markup of the message
⚠️ Erreur édition caption, tentative édition texte: 400: Bad Request: message is not modified: specified new message content and reply markup are exactly the same as a current content and reply markup of the message
Erreur dans handleResetFilters: TelegramError: 400: Bad Request: there is no text in the message to edit
    at Telegram.callApi (/workspace/bot/node_modules/telegraf/lib/core/network/client.js:315:19)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async handleResetFilters (/workspace/bot/src/handlers/plugsHandler.js:512:9)
    at async execute (/workspace/bot/node_modules/telegraf/lib/composer.js:518:17)
    at async /workspace/bot/node_modules/telegraf/lib/composer.js:519:21
    at async execute (/workspace/bot/node_modules/telegraf/lib/composer.js:518:17)
    at async /workspace/bot/node_modules/telegraf/lib/composer.js:519:21
    at async execute (/workspace/bot/node_modules/telegraf/lib/composer.js:518:17)
    at async /workspace/bot/node_modules/telegraf/lib/composer.js:519:21
    at async execute (/workspace/bot/node_modules/telegraf/lib/composer.js:518:17) {
  response: {
    ok: false,
    error_code: 400,
    description: 'Bad Request: there is no text in the message to edit'
  },
  on: {
    method: 'editMessageText',
    payload: {
      chat_id: 7548021607,
      message_id: 5824,
      inline_message_id: undefined,
      reply_markup: [Object],
      parse_mode: 'Markdown',
      text: '🔝 Top Tiendas\n' +
        '*(Ordenados por número de votos)*\n' +
        '\n' +
        '**1 tiendas disponibles :**\n' +
        '\n'
    }
  }
}
🔄 Callback reçu: top_service_delivery_
👤 User ID: 7548021607, Chat ID: 7548021607
📝 Message ID: 5824
🖼️ Images: plug=false, welcome=true, isPlugDetails=false, using=true
🖼️ Modification avec image: https://i.imgur.com/soi9PbO.jpeg
🔄 Callback reçu: top_service_meetup
👤 User ID: 7548021607, Chat ID: 7548021607
📝 Message ID: 5824
🖼️ Images: plug=false, welcome=true, isPlugDetails=false, using=true
🖼️ Modification avec image: https://i.imgur.com/soi9PbO.jpeg
🔄 Callback reçu: top_service_postal
👤 User ID: 7548021607, Chat ID: 7548021607
📝 Message ID: 5824
🖼️ Images: plug=false, welcome=true, isPlugDetails=false, using=true
🖼️ Modification avec image: https://i.imgur.com/soi9PbO.jpeg
🔄 Callback reçu: top_reset_filters
👤 User ID: 7548021607, Chat ID: 7548021607
📝 Message ID: 5824
🔄 Callback reçu: plug_68835c4222586e073b5d57c3_from_top_plugs
👤 User ID: 7548021607, Chat ID: 7548021607
📝 Message ID: 5824
📍 Context updated to: top_plugs
🔍 handlePlugDetails: plugId=68835c4222586e073b5d57c3, returnContext=top_plugs
📦 Plug found: teste (active: true)
🖼️ Images: plug=true, welcome=true, isPlugDetails=true, using=true
🖼️ Modification avec image: https://i.imgur.com/PKYuVrg.jpeg
🔄 Callback reçu: top_plugs
👤 User ID: 7548021607, Chat ID: 7548021607
📝 Message ID: 5824
📍 Context updated to: top_plugs
🔝 Top Plugs affiché en langue: es
🖼️ Images: plug=false, welcome=true, isPlugDetails=false, using=true
🖼️ Modification avec image: https://i.imgur.com/soi9PbO.jpeg
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🚀 Commande /start reçue de: 7670522278
❌ Erreur lors de l'enregistrement utilisateur: StrictModeError: Path "userId" is not in schema, strict mode is `true`, and upsert is `true`.
    at cast (/workspace/bot/node_modules/mongoose/lib/cast.js:305:17)
    at Query.cast (/workspace/bot/node_modules/mongoose/lib/query.js:5055:12)
    at Query._castConditions (/workspace/bot/node_modules/mongoose/lib/query.js:2351:10)
    at model.Query._findOneAndUpdate (/workspace/bot/node_modules/mongoose/lib/query.js:3454:8)
    at model.Query.exec (/workspace/bot/node_modules/mongoose/lib/query.js:4604:80)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async handleStart (/workspace/bot/src/handlers/startHandler.js:65:7)
    at async execute (/workspace/bot/node_modules/telegraf/lib/composer.js:518:17)
    at async /workspace/bot/node_modules/telegraf/lib/composer.js:519:21
    at async execute (/workspace/bot/node_modules/telegraf/lib/composer.js:518:17) {
  isImmutableError: false,
  path: 'userId'
}
🔄 Config rechargée depuis la DB
🌍 Menu principal affiché en langue: es
📸 Envoi message avec image: https://i.imgur.com/soi9PbO.jpeg
✅ Message avec image envoyé
🔄 Callback reçu: select_language
👤 User ID: 7670522278, Chat ID: 7670522278
📝 Message ID: 5826
🌍 Affichage sélecteur langue, langue actuelle: es
🌍 Création clavier langue, langue actuelle: es
🔤 Langue fr: 🇫🇷 Français (sélectionnée: false)
🔤 Langue en: 🇬🇧 English (sélectionnée: false)
🔤 Langue it: 🇮🇹 Italiano (sélectionnée: false)
🔤 Langue es: ✅ 🇪🇸 Español (sélectionnée: true)
🔤 Langue de: 🇩🇪 Deutsch (sélectionnée: false)
✅ Clavier langue créé avec 5 langues
✅ Message avec image modifié pour sélection langue
🔄 Callback reçu: lang_fr
👤 User ID: 7670522278, Chat ID: 7670522278
📝 Message ID: 5826
🌍 Changement de langue vers: fr
✅ Langue sauvegardée: fr
🧹 Tous les caches vidés
🔙 Retour au menu principal demandé
📋 Configuration récupérée pour le retour
🌍 Langue actuelle pour le retour: fr
📝 Message d'accueil préparé pour le retour avec traduction
🖼️ Images: plug=false, welcome=true, isPlugDetails=false, using=true
🖼️ Modification avec image: https://i.imgur.com/soi9PbO.jpeg
✅ Retour au menu principal terminé
🔄 Callback reçu: start_application
👤 User ID: 7670522278, Chat ID: 7670522278
📝 Message ID: 5826
🌍 Formulaire d'inscription en langue: fr
⚠️ editMessageText échoué: 400: Bad Request: there is no text in the message to edit
🔄 Callback reçu: cancel_application
👤 User ID: 7670522278, Chat ID: 7670522278
📝 Message ID: 5827
🔄 Callback reçu: back_main
👤 User ID: 7670522278, Chat ID: 7670522278
📝 Message ID: 5827
🔙 Retour au menu principal demandé
📋 Configuration récupérée pour le retour
🌍 Langue actuelle pour le retour: fr
📝 Message d'accueil préparé pour le retour avec traduction
🖼️ Images: plug=false, welcome=true, isPlugDetails=false, using=true
🖼️ Modification avec image: https://i.imgur.com/soi9PbO.jpeg
✅ Retour au menu principal terminé
🔄 Callback reçu: info
👤 User ID: 7670522278, Chat ID: 7670522278
📝 Message ID: 5827
🔄 Callback reçu: contact
👤 User ID: 7670522278, Chat ID: 7670522278
📝 Message ID: 5827
🔄 Callback reçu: top_plugs
👤 User ID: 7670522278, Chat ID: 7670522278
📝 Message ID: 5827
📍 Context updated to: top_plugs
🔝 Top Plugs affiché en langue: fr
🖼️ Images: plug=false, welcome=true, isPlugDetails=false, using=true
🖼️ Modification avec image: https://i.imgur.com/soi9PbO.jpeg
🔄 Callback reçu: plug_68835c4222586e073b5d57c3_from_top_plugs
👤 User ID: 7670522278, Chat ID: 7670522278
📝 Message ID: 5827
📍 Context updated to: top_plugs
🔍 handlePlugDetails: plugId=68835c4222586e073b5d57c3, returnContext=top_plugs
📦 Plug found: teste (active: true)
🖼️ Images: plug=true, welcome=true, isPlugDetails=true, using=true
🖼️ Modification avec image: https://i.imgur.com/PKYuVrg.jpeg
🔄 Callback reçu: top_plugs
👤 User ID: 7670522278, Chat ID: 7670522278
📝 Message ID: 5827
📍 Context updated to: top_plugs
🔝 Top Plugs affiché en langue: fr
🖼️ Images: plug=false, welcome=true, isPlugDetails=false, using=true
🖼️ Modification avec image: https://i.imgur.com/soi9PbO.jpeg
🔄 Callback reçu: top_service_postal_
👤 User ID: 7670522278, Chat ID: 7670522278
📝 Message ID: 5827
🖼️ Images: plug=false, welcome=true, isPlugDetails=false, using=true
🖼️ Modification avec image: https://i.imgur.com/soi9PbO.jpeg
🔄 Callback reçu: top_service_meetup
👤 User ID: 7670522278, Chat ID: 7670522278
📝 Message ID: 5827
🖼️ Images: plug=false, welcome=true, isPlugDetails=false, using=true
🖼️ Modification avec image: https://i.imgur.com/soi9PbO.jpeg
🔄 Callback reçu: top_departments_meetup
👤 User ID: 7670522278, Chat ID: 7670522278
📝 Message ID: 5827
🔄 Callback reçu: top_departments_meetup
👤 User ID: 7670522278, Chat ID: 7670522278
📝 Message ID: 5827
🔄 Callback reçu: top_service_delivery
👤 User ID: 7670522278, Chat ID: 7670522278
📝 Message ID: 5827
🔄 Rafraîchissement du cache...
🖼️ Images: plug=false, welcome=true, isPlugDetails=false, using=true
🖼️ Modification avec image: https://i.imgur.com/soi9PbO.jpeg
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Callback reçu: top_departments_delivery
👤 User ID: 7670522278, Chat ID: 7670522278
📝 Message ID: 5827
🔄 Callback reçu: top_country_Suisse
👤 User ID: 7670522278, Chat ID: 7670522278
📝 Message ID: 5827
🖼️ Images: plug=false, welcome=true, isPlugDetails=false, using=true
🖼️ Modification avec image: https://i.imgur.com/soi9PbO.jpeg
🔄 Callback reçu: top_country_Belgique
👤 User ID: 7670522278, Chat ID: 7670522278
📝 Message ID: 5827
🖼️ Images: plug=false, welcome=true, isPlugDetails=false, using=true
🖼️ Modification avec image: https://i.imgur.com/soi9PbO.jpeg
🔄 Callback reçu: top_country_France
👤 User ID: 7670522278, Chat ID: 7670522278
📝 Message ID: 5827
🖼️ Images: plug=false, welcome=true, isPlugDetails=false, using=true
🖼️ Modification avec image: https://i.imgur.com/soi9PbO.jpeg
🔄 Callback reçu: top_service_delivery_France
👤 User ID: 7670522278, Chat ID: 7670522278
📝 Message ID: 5827
🖼️ Images: plug=false, welcome=true, isPlugDetails=false, using=true
🖼️ Modification avec image: https://i.imgur.com/soi9PbO.jpeg
📡 GET /health - IP: ::1 - UserAgent: undefined
📋 Headers: [ 'host', 'connection' ]
📡 GET /api/public/config - IP: ::1 - UserAgent: undefined
📋 Headers: [ 'host', 'connection' ]
🔍 Récupération config publique pour la boutique
📊 Config récupérée pour boutique: {
  boutique: 'FINDYOURPLUG',
  logo: 'Non défini',
  background: 'Non défini'
}
📡 GET /api/public/plugs - IP: ::1 - UserAgent: undefined
📋 Headers: [ 'host', 'connection' ]
📡 GET /api/test/db - IP: ::1 - UserAgent: undefined
📋 Headers: [ 'host', 'connection' ]
📡 GET /api/public/plugs - IP: ::1 - UserAgent: undefined
📋 Headers: [ 'host', 'connection' ]
📡 GET /api/public/config - IP: ::1 - UserAgent: undefined
📋 Headers: [ 'host', 'connection' ]
🔍 Récupération config publique pour la boutique
📊 Config récupérée pour boutique: {
  boutique: 'FINDYOURPLUG',
  logo: 'Non défini',
  background: 'Non défini'
}
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
📡 GET /api/public/plugs - IP: ::1 - UserAgent: curl/8.12.1
📋 Headers: [ 'host', 'user-agent', 'accept' ]
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
📡 GET /api/public/plugs - IP: ::1 - UserAgent: undefined
📋 Headers: [ 'host', 'connection' ]
📡 POST /api/admin/plugs - IP: ::1 - UserAgent: undefined
📋 Headers: [ 'content-type', 'content-length', 'host', 'connection' ]
📡 GET /api/public/plugs - IP: ::1 - UserAgent: undefined
📋 Headers: [ 'host', 'connection' ]
📡 GET /api/public/plugs - IP: ::1 - UserAgent: undefined
📋 Headers: [ 'host', 'connection' ]
📡 GET /api/public/plugs - IP: ::1 - UserAgent: curl/8.12.1
📋 Headers: [ 'host', 'user-agent', 'accept' ]
📡 GET /api/public/plugs - IP: ::1 - UserAgent: curl/8.12.1
📋 Headers: [ 'host', 'user-agent', 'accept' ]
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🚀 Commande /start reçue de: 7670522278
❌ Erreur lors de l'enregistrement utilisateur: StrictModeError: Path "userId" is not in schema, strict mode is `true`, and upsert is `true`.
    at cast (/workspace/bot/node_modules/mongoose/lib/cast.js:305:17)
    at Query.cast (/workspace/bot/node_modules/mongoose/lib/query.js:5055:12)
    at Query._castConditions (/workspace/bot/node_modules/mongoose/lib/query.js:2351:10)
    at model.Query._findOneAndUpdate (/workspace/bot/node_modules/mongoose/lib/query.js:3454:8)
    at model.Query.exec (/workspace/bot/node_modules/mongoose/lib/query.js:4604:80)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async handleStart (/workspace/bot/src/handlers/startHandler.js:65:7)
    at async execute (/workspace/bot/node_modules/telegraf/lib/composer.js:518:17)
    at async /workspace/bot/node_modules/telegraf/lib/composer.js:519:21
    at async execute (/workspace/bot/node_modules/telegraf/lib/composer.js:518:17) {
  isImmutableError: false,
  path: 'userId'
}
🔄 Config rechargée depuis la DB
🌍 Menu principal affiché en langue: fr
📸 Envoi message avec image: https://i.imgur.com/soi9PbO.jpeg
✅ Message avec image envoyé
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🚀 Commande /start reçue de: 7670522278
❌ Erreur lors de l'enregistrement utilisateur: StrictModeError: Path "userId" is not in schema, strict mode is `true`, and upsert is `true`.
    at cast (/workspace/bot/node_modules/mongoose/lib/cast.js:305:17)
    at Query.cast (/workspace/bot/node_modules/mongoose/lib/query.js:5055:12)
    at Query._castConditions (/workspace/bot/node_modules/mongoose/lib/query.js:2351:10)
    at model.Query._findOneAndUpdate (/workspace/bot/node_modules/mongoose/lib/query.js:3454:8)
    at model.Query.exec (/workspace/bot/node_modules/mongoose/lib/query.js:4604:80)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async handleStart (/workspace/bot/src/handlers/startHandler.js:65:7)
    at async execute (/workspace/bot/node_modules/telegraf/lib/composer.js:518:17)
    at async /workspace/bot/node_modules/telegraf/lib/composer.js:519:21
    at async execute (/workspace/bot/node_modules/telegraf/lib/composer.js:518:17) {
  isImmutableError: false,
  path: 'userId'
}
🌍 Menu principal affiché en langue: fr
📸 Envoi message avec image: https://i.imgur.com/soi9PbO.jpeg
✅ Message avec image envoyé
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
🔄 Rafraîchissement du cache...
✅ Cache mis à jour - 1 plugs, config: OK
/workspace/bot/node_modules/telegraf/lib/core/network/client.js:315
            throw new error_1.default(data, { method, payload });
                  ^

TelegramError: 409: Conflict: terminated by setWebhook request
    at Telegram.callApi (/workspace/bot/node_modules/telegraf/lib/core/network/client.js:315:19)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async [Symbol.asyncIterator] (/workspace/bot/node_modules/telegraf/lib/core/network/polling.js:30:33)
    at async Polling.loop (/workspace/bot/node_modules/telegraf/lib/core/network/polling.js:73:30)
    at async Telegraf.launch (/workspace/bot/node_modules/telegraf/lib/telegraf.js:194:13) {
  response: {
    ok: false,
    error_code: 409,
    description: 'Conflict: terminated by setWebhook request'
  },
  on: {
    method: 'getUpdates',
    payload: { timeout: 50, offset: 891035290, allowed_updates: [] }
  }
}

Node.js v22.16.0
